8{% extends "fittings/base.html" %}

{% load aa_i18n %}
{% load i18n %}
{% load humanize %}
{% load filters %}
{% load evelinks %}

{% block page_title %}{% translate "Doctrine List" %}{% endblock %}

{% block extra_css %}
    <style>
        #docTable th.figl-ships-col,
        #docTable td.figl-ships-col {
            width: 15%;
            min-width: 15%;
        }
    </style>
{% endblock %}

{% block fittings_block %}
    {% if msg %}
        <div class="alert alert-{{ msg.0 }} alert-dismissible" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="close">
                <span aria-hidden="true">&times</span>
            </button>

            <h4>
                {% if msg.0 == 'danger' %}
                    {% translate "Oh No!" %}
                {% elif msg.0 == 'success' %}
                    {% translate "Success!" %}
                {% endif %}
            </h4>
            <p>{{ msg.1 }}</p>
        </div>
    {% endif %}

    <div>
        <div class="card card-default mb-3">
            <div class="card-header">
                <div class="card-title mb-0">{% translate "Doctrine List" %}</div>
            </div>

            <div class="card-body">
                {% include "fittings/partials/doctrine-list-table.html" %}
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_javascript %}
    {% include 'bundles/datatables-js-bs5.html' %}

    {% get_datatables_language_static LANGUAGE_CODE as DT_LANG_PATH %}
    {% translate "Ships" as ships_label %}
    {% translate "All" as all_label %}

    <script>
        $(document).ready(() => {
            {% if docs %}
                const doctrineTable = $('#docTable');
                const shipsHeader = "{{ ships_label|escapejs }}";
                const headerCells = doctrineTable.find('thead th');
                const shipsIndex = headerCells.toArray().findIndex((th) => {
                    const headerText = $(th).text().trim().toLowerCase();
                    return headerText.includes(shipsHeader.toLowerCase());
                });
                const columnDefs = [];

                if (shipsIndex >= 0) {
                    $(headerCells[shipsIndex]).addClass('figl-ships-col');
                    columnDefs.push({
                        targets: shipsIndex,
                        width: "15%",
                        className: "figl-ships-col"
                    });
                }

                doctrineTable.DataTable({
                    language: {
                        url: '{{ DT_LANG_PATH }}'
                    },
                    order: [[ 0, "asc" ]],
                    pageLength: 100,
                    lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "{{ all_label|escapejs }}"]],
                    autoWidth: false,
                    columnDefs: columnDefs,
                    initComplete: () => {
                        // Initialize tooltips
                        $('[data-bs-tooltip="aa-fittings"]').tooltip();

                        // Reinitialize tooltips on table redraw
                        const dt = doctrineTable.DataTable();

                        dt.on('draw', () => {
                            $('[data-bs-tooltip="aa-fittings"]').tooltip();
                        });
                    }
                });
            {% endif %}
        });
    </script>
{% endblock %}
